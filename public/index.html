<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ralph Loves Trends - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            height: 400px;
        }

        .trends-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .trends-header {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trends-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .trend-item {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .trend-item:hover {
            background-color: #f8f9ff;
        }

        .trend-info h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1.2rem;
        }

        .trend-meta {
            color: #666;
            font-size: 0.9rem;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .trend-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-positive { background: #d4edda; color: #155724; }
        .badge-neutral { background: #ffeaa7; color: #856404; }
        .badge-negative { background: #f8d7da; color: #721c24; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .confidence-bar {
            width: 60px;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48cab3);
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <header class="header">
            <h1><i class="fas fa-chart-trending-up"></i> Ralph Loves Trends</h1>
            <p>AI-Powered Trend Intelligence Dashboard</p>
        </header>

        <div class="controls">
            <div class="filter-group">
                <label for="platform">Platform:</label>
                <select id="platform">
                    <option value="">All Platforms</option>
                    <option value="TikTok">TikTok</option>
                    <option value="Pinterest">Pinterest</option>
                    <option value="Twitter/X">Twitter/X</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="sentiment">Sentiment:</label>
                <select id="sentiment">
                    <option value="">All Sentiments</option>
                    <option value="positive">Positive</option>
                    <option value="neutral">Neutral</option>
                    <option value="negative">Negative</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="timeframe">Timeframe:</label>
                <select id="timeframe">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="loadTrends()">
                <i class="fas fa-refresh"></i> Refresh
            </button>

            <button class="btn btn-secondary" onclick="runScraping()">
                <i class="fas fa-spider"></i> Scrape Now
            </button>
            
            <button class="btn btn-secondary" onclick="checkDebugData()">
                <i class="fas fa-bug"></i> Debug Data
            </button>
            
            <button class="btn btn-secondary" onclick="clearDebugData()" style="background: #dc3545;">
                <i class="fas fa-trash"></i> Clear DB
            </button>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-hashtag"></i></div>
                <div class="stat-number" id="totalTrends">-</div>
                <div class="stat-label">Total Trends</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-number" id="recentTrends">-</div>
                <div class="stat-label">Recent (24h)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-fire"></i></div>
                <div class="stat-number" id="hotTrends">-</div>
                <div class="stat-label">High Confidence</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-brain"></i></div>
                <div class="stat-number" id="aiInsights">-</div>
                <div class="stat-label">AI Analyzed</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="platformChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="sentimentChart"></canvas>
            </div>
        </div>

        <div class="trends-container">
            <div class="trends-header">
                <h2><i class="fas fa-trending-up"></i> Latest Trends</h2>
                <span id="trendsCount">Loading...</span>
            </div>
            <div class="trends-list" id="trendsList">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading trends...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let platformChart, sentimentChart;

        async function loadStats() {
            try {
                const response = await fetch('/api/trends/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalTrends').textContent = data.data.totalTrends.toLocaleString();
                    document.getElementById('recentTrends').textContent = data.data.recentTrends.toLocaleString();
                    
                    const highConfidence = data.data.totalTrends * 0.3;
                    document.getElementById('hotTrends').textContent = Math.round(highConfidence).toLocaleString();
                    document.getElementById('aiInsights').textContent = data.data.totalTrends.toLocaleString();

                    updateCharts(data.data);
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadTrends() {
            const platform = document.getElementById('platform').value;
            const sentiment = document.getElementById('sentiment').value;
            
            try {
                const params = new URLSearchParams();
                if (platform) params.append('platform', platform);
                if (sentiment) params.append('sentiment', sentiment);
                params.append('limit', '30');

                const response = await fetch(`/api/trends?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    displayTrends(data.data);
                    document.getElementById('trendsCount').textContent = `${data.data.length} trends`;
                }
            } catch (error) {
                console.error('Failed to load trends:', error);
            }
        }

        function displayTrends(trends) {
            const container = document.getElementById('trendsList');
            
            if (trends.length === 0) {
                container.innerHTML = '<div class="loading"><p>No trends found</p></div>';
                return;
            }

            container.innerHTML = trends.map(trend => `
                <div class="trend-item">
                    <div class="trend-info">
                        <h3>${trend.hashtag || 'No hashtag'}</h3>
                        <div class="trend-meta">
                            <span><i class="fas fa-eye"></i> ${trend.popularity || 'N/A'}</span>
                            <span><i class="fas fa-tag"></i> ${trend.category || 'Uncategorized'}</span>
                            <span><i class="fab fa-${getPlatformIcon(trend.platform)}"></i> ${trend.platform || 'Unknown'}</span>
                            <span class="trend-badge badge-${trend.sentiment || 'neutral'}">${trend.sentiment || 'neutral'}</span>
                            <span class="confidence-bar">
                                <div class="confidence-fill" style="width: ${(trend.confidence || 0.5) * 100}%"></div>
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getPlatformIcon(platform) {
            const icons = {
                'TikTok': 'tiktok',
                'Pinterest': 'pinterest',
                'Twitter/X': 'twitter'
            };
            return icons[platform] || 'globe';
        }

        function updateCharts(data) {
            updatePlatformChart(data.platformStats);
            updateSentimentChart(data.sentimentStats);
        }

        function updatePlatformChart(platformStats) {
            const ctx = document.getElementById('platformChart').getContext('2d');
            
            if (platformChart) {
                platformChart.destroy();
            }

            platformChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: platformStats.map(p => p.platform || 'Unknown'),
                    datasets: [{
                        data: platformStats.map(p => p.count),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trends by Platform'
                        }
                    }
                }
            });
        }

        function updateSentimentChart(sentimentStats) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            if (sentimentChart) {
                sentimentChart.destroy();
            }

            sentimentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sentimentStats.map(s => s.sentiment || 'Unknown'),
                    datasets: [{
                        label: 'Count',
                        data: sentimentStats.map(s => s.count),
                        backgroundColor: [
                            '#48cab3',
                            '#feca57',
                            '#ff6b6b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sentiment Distribution'
                        }
                    }
                }
            });
        }

        let statusInterval = null;

        async function runScraping() {
            try {
                const button = document.querySelector('button[onclick="runScraping()"]');
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';
                button.disabled = true;

                // Create progress display
                showProgressModal();

                const response = await fetch('/api/scrape', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    updateProgressModal('🚀 Scraping started successfully!', 0, 'Preparing to scrape sources...');
                    
                    // Initialize source progress display with pending sources
                    if (data.status && data.status.sources) {
                        updateSourcesProgress(data.status.sources);
                    }
                    
                    // Start polling for status updates
                    statusInterval = setInterval(checkScrapingStatus, 2000);
                    
                } else {
                    updateProgressModal('❌ Failed to start scraping', 0, data.message || 'Unknown error');
                    setTimeout(() => {
                        hideProgressModal();
                        resetScrapeButton();
                    }, 3000);
                }
            } catch (error) {
                console.error('Scraping failed:', error);
                updateProgressModal('💥 Error occurred', 0, error.message);
                setTimeout(() => {
                    hideProgressModal();
                    resetScrapeButton();
                }, 3000);
            }
        }

        async function checkScrapingStatus() {
            try {
                const response = await fetch('/api/scrape/status');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const status = data.data;
                    
                    if (status.isRunning) {
                        const progress = Math.round((status.completedSources / status.totalSources) * 100);
                        const currentSource = status.currentSource || 'Processing...';
                        
                        // Update overall progress
                        updateProgressModal(
                            `🎯 Scraping in Progress`,
                            progress,
                            `Completed ${status.completedSources}/${status.totalSources} sources - Current: ${currentSource}`
                        );
                        
                        // Update detailed source progress
                        if (status.sources && status.sources.length > 0) {
                            updateSourcesProgress(status.sources);
                        }
                    } else {
                        // Scraping completed
                        clearInterval(statusInterval);
                        const totalTrends = status.sources ? status.sources.reduce((sum, s) => sum + s.trends, 0) : status.trends.length;
                        const finalMessage = totalTrends > 0 
                            ? `✅ Scraping completed! Found ${totalTrends} trends`
                            : '⚠️ Scraping completed but no trends found';
                        
                        updateProgressModal(finalMessage, 100, 'Refreshing dashboard...');
                        
                        // Update final source states
                        if (status.sources && status.sources.length > 0) {
                            updateSourcesProgress(status.sources);
                        }
                        
                        setTimeout(() => {
                            hideProgressModal();
                            resetScrapeButton();
                            loadStats();
                            loadTrends();
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Status check failed:', error);
                clearInterval(statusInterval);
                hideProgressModal();
                resetScrapeButton();
            }
        }

        function showProgressModal() {
            const modalHTML = `
                <div id="progress-modal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    overflow-y: auto;
                ">
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        min-width: 500px;
                        max-width: 700px;
                        text-align: left;
                        margin: 20px;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <h3 id="progress-title" style="margin-bottom: 20px; color: #333; text-align: center;">🚀 Starting Scrape...</h3>
                        
                        <!-- Overall Progress -->
                        <div style="margin-bottom: 20px;">
                            <div style="
                                width: 100%;
                                height: 20px;
                                background: #f0f0f0;
                                border-radius: 10px;
                                overflow: hidden;
                                margin-bottom: 10px;
                            ">
                                <div id="progress-bar" style="
                                    width: 0%;
                                    height: 100%;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    transition: width 0.3s ease;
                                "></div>
                            </div>
                            <div id="progress-status" style="color: #666; font-size: 14px; text-align: center;">Initializing...</div>
                        </div>

                        <!-- Source-by-Source Progress -->
                        <div id="sources-container" style="
                            border-top: 2px solid #f0f0f0;
                            padding-top: 15px;
                        ">
                            <h4 style="margin-bottom: 15px; color: #555; font-size: 16px;">📊 Source Progress</h4>
                            <div id="sources-list">
                                <!-- Sources will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function updateProgressModal(title, progress, status, details = '') {
            const titleEl = document.getElementById('progress-title');
            const barEl = document.getElementById('progress-bar');
            const statusEl = document.getElementById('progress-status');
            
            if (titleEl) titleEl.textContent = title;
            if (barEl) barEl.style.width = progress + '%';
            if (statusEl) statusEl.textContent = status;
        }

        function updateSourcesProgress(sources) {
            const sourcesListEl = document.getElementById('sources-list');
            if (!sourcesListEl) return;

            const sourcesHTML = sources.map(source => {
                const statusIcon = {
                    'pending': '⏳',
                    'running': '🚀',
                    'completed': '✅',
                    'failed': '❌'
                }[source.status] || '⏳';

                const statusColor = {
                    'pending': '#999',
                    'running': '#007bff',
                    'completed': '#28a745',
                    'failed': '#dc3545'
                }[source.status] || '#999';

                const progressBarColor = {
                    'pending': '#e9ecef',
                    'running': '#007bff',
                    'completed': '#28a745',
                    'failed': '#dc3545'
                }[source.status] || '#e9ecef';

                return `
                    <div style="
                        margin-bottom: 15px;
                        padding: 15px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid ${statusColor};
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 8px;
                        ">
                            <strong style="color: #333; font-size: 14px;">
                                ${statusIcon} ${source.name}
                            </strong>
                            <span style="
                                color: ${statusColor};
                                font-size: 12px;
                                font-weight: bold;
                            ">
                                ${source.trends} trends
                            </span>
                        </div>
                        
                        <!-- Source Progress Bar -->
                        <div style="
                            width: 100%;
                            height: 8px;
                            background: #e9ecef;
                            border-radius: 4px;
                            overflow: hidden;
                            margin-bottom: 8px;
                        ">
                            <div style="
                                width: ${source.progress}%;
                                height: 100%;
                                background: ${progressBarColor};
                                transition: width 0.3s ease;
                            "></div>
                        </div>
                        
                        <div style="
                            color: #666;
                            font-size: 12px;
                        ">
                            ${source.details || 'Waiting...'}
                            ${source.error ? `<br><span style="color: #dc3545;">Error: ${source.error}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            sourcesListEl.innerHTML = sourcesHTML;
        }

        function hideProgressModal() {
            const modal = document.getElementById('progress-modal');
            if (modal) {
                modal.remove();
            }
        }

        function resetScrapeButton() {
            const button = document.querySelector('button[onclick="runScraping()"]');
            if (button) {
                button.innerHTML = '<i class="fas fa-spider"></i> Scrape Now';
                button.disabled = false;
            }
        }

        async function checkDebugData() {
            try {
                const response = await fetch('/api/debug/trends');
                const data = await response.json();
                
                console.log('Debug Data:', data);
                
                if (data.success && data.data) {
                    alert(`Found ${data.count} trends in database:\n\n${data.data.slice(0, 3).map(t => `• ${t.hashtag} (${t.platform}) - ${t.scrapedAt}`).join('\n')}\n\n${data.count > 3 ? `...and ${data.count - 3} more` : ''}\n\nCheck console for full details.`);
                } else {
                    alert('No trends found in database.');
                }
            } catch (error) {
                console.error('Debug check failed:', error);
                alert('Failed to check debug data: ' + error.message);
            }
        }

        async function clearDebugData() {
            if (!confirm('Are you sure you want to clear all trends from the database? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/debug/trends', { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    loadStats();
                    loadTrends();
                } else {
                    alert('Failed to clear database: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Clear database failed:', error);
                alert('Failed to clear database: ' + error.message);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadTrends();
            
            document.getElementById('platform').addEventListener('change', loadTrends);
            document.getElementById('sentiment').addEventListener('change', loadTrends);
        });

        setInterval(() => {
            loadStats();
            loadTrends();
        }, 60000);
    </script>
</body>
</html>